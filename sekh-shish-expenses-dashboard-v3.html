<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة مصروفات مطعم سيخ وشيش</title>

  <!-- Fonts & Charts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f19;--bg-grad:linear-gradient(180deg,#070b13,#0b0f19 60%);
      --card:#121829;--muted:#1b2440;--ink:#e7ecf3;--ink-dim:#9fb0ca;--accent:#4f8cff;--accent-2:#22c55e;
      --danger:#ef4444;--warning:#f59e0b;--shadow:0 10px 30px rgba(0,0,0,.35);
      --field:#0e1424;--field-border:#1a2236;--row-hover:#0e1424;--card-border:#1b2233;
      --kpi-grad:linear-gradient(180deg,#0f1629,#0b1222 140%);
      --gap:clamp(10px,1.8vw,16px);--pad:clamp(12px,2.2vw,18px);
    }
    body.light{
      --bg:#f5f7fb;--bg-grad:linear-gradient(180deg,#fff,#eef2f8 60%);
      --card:#fff;--muted:#e8edf6;--ink:#1e293b;--ink-dim:#475569;--accent:#2563eb;--accent-2:#16a34a;
      --danger:#dc2626;--warning:#d97706;--shadow:0 6px 18px rgba(0,0,0,.08);
      --field:#fff;--field-border:#d7deea;--row-hover:#f3f6fb;--card-border:#e5ecf6;
      --kpi-grad:linear-gradient(180deg,#fff,#f6f9ff 140%)
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg-grad);color:var(--ink);transition:background .25s,color .25s}
    header{position:sticky;top:0;z-index:10;background:color-mix(in oklab,var(--bg) 60%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border)}
    .container{max-width:1200px;margin:0 auto;padding:20px;padding-inline:max(16px,2vw)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--ink-dim);font-size:13px}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:16px;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--field);color:var(--ink);border:1px solid var(--field-border)}
    .btn.success{background:var(--accent-2)}
    .btn.warn{background:var(--warning);color:#111827}
    .btn.danger{background:var(--danger)}
    .card{background:linear-gradient(180deg,var(--card),#0f1629 120%);border:1px solid var(--card-border);border-radius:28px}
    .card-head{padding:12px var(--pad);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border)}
    .card-body{padding:var(--pad)}
    .grid{display:grid;gap:var(--gap)}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:1100px){.grid-3{grid-template-columns:1fr 1fr}}
    @media (max-width:720px){.grid-2,.grid-3{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--ink-dim);margin:2px 2px 8px}
    input,select{width:100%;background:var(--field);color:var(--ink);border:1px solid var(--field-border);padding:10px 12px;border-radius:12px}
    input:focus,select:focus{outline:0;border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 22%, transparent)}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}}
    @media (max-width:580px){.kpis{grid-template-columns:1fr}}
    .kpi{padding:16px;border-radius:28px;background:var(--kpi-grad);border:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center}
    .kpi .val{font-size:clamp(18px,2.2vw,22px);font-weight:800}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--field-border);font-size:14px}
    thead th{position:sticky;top:0;background:color-mix(in oklab,var(--card) 88%, transparent 12%);color:#9fb0ca}
    tbody tr{transition:background .2s,transform .06s}
    tbody tr:hover{background:var(--row-hover);transform:translateY(-1px)}
    .pill{padding:4px 10px;border-radius:9999px;font-size:12px;border:1px solid #1f2a44;font-weight:700}
    .pill.paid{background:rgba(34,197,94,.1);color:#a7f3d0;border-color:rgba(34,197,94,.35)}
    .pill.unpaid{background:rgba(239,68,68,.08);color:#fecaca;border-color:rgba(239,68,68,.35)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header>
    <section style="display:flex;justify-content:center;padding:24px 0 8px">
      <img src="logo.png" alt="شعار سيخ وشيش" style="width:200px;border-radius:22px;padding:14px;background:#ffffff14">
    </section>
  </header>

  <section>
    <div class="container">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <div class="muted">إدارة المصروفات <b style="color:var(--accent)">سيخ وشيش</b></div>
          <button id="toggleTheme" class="btn secondary">تبديل المظهر</button>
        </div>
        <!-- Auth + Sync (معلّقة افتراضيًا) -->
        <!--
        <form id="loginForm" class="row">
          <input id="email" type="email" placeholder="البريد" required style="min-width:180px">
          <input id="password" type="password" placeholder="كلمة المرور" required style="min-width:140px" autocomplete="current-password">
          <button class="btn">دخول</button>
        </form>
        <div id="authArea" class="row" style="display:none">
          <span id="who" class="muted"></span>
          <button class="btn secondary" id="pullRemote">سحب من Supabase</button>
          <button class="btn success" id="pushRemote">رفع إلى Supabase</button>
          <button class="btn danger" id="logoutBtn">خروج</button>
        </div>
        -->
      </div>
    </div>
  </section>

  <main class="container">

    <!-- الرسوم (في الأعلى) -->
    <section class="grid grid-2">
      <div class="card">
        <div class="card-head">
          <strong>مصروفات أيام الشهر المحدد</strong>
          <span class="muted" id="chartMonthLabel"></span>
        </div>
        <div class="card-body"><canvas id="chartMonthDays"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><strong>أعلى الشركات صرفًا (حسب التصفية)</strong></div>
        <div class="card-body"><canvas id="chartTopCompanies"></canvas></div>
      </div>
    </section>
    <section style="margin-top:16px" class="grid grid-2">
      <div class="card">
        <div class="card-head"><strong>أعلى الأصناف صرفًا (حسب التصفية)</strong></div>
        <div class="card-body"><canvas id="chartTopCategories"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><strong>المبيعات مقابل المصروفات (شهريًا)</strong></div>
        <div class="card-body"><canvas id="chartSalesVsExpenses"></canvas></div>
      </div>
    </section>
    <section style="margin-top:16px" class="grid grid-2">
      <div class="card">
        <div class="card-head"><strong>هامش الربح الشهري</strong></div>
        <div class="card-body"><canvas id="chartMonthlyMargin"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><strong>توزيع قنوات البيع (للشهر المحدد)</strong></div>
        <div class="card-body"><canvas id="chartChannelShare"></canvas></div>
      </div>
    </section>

    <!-- البحث والتصفية -->
    <section class="card" style="margin-top:16px">
      <div class="card-head">
        <strong>البحث والتصفية</strong>
        <div class="muted">السنة الحالية: <span id="currentYear"></span></div>
      </div>
      <div class="card-body grid grid-3">
        <div><label>بحث عام</label><input id="q" type="text" placeholder="اسم/شركة/صنف/حالة..." /></div>
        <div><label>الشهر</label><select id="filterMonth"></select></div>
        <div><label>الشركة</label><select id="filterCompany"></select></div>
        <div><label>الصنف</label><select id="filterCategory"></select></div>
        <div>
          <label>الحالة</label>
          <select id="filterStatus">
            <option value="">الكل</option>
            <option value="paid">تم الصرف</option>
            <option value="unpaid">لم يتم</option>
          </select>
        </div>
        <div><label>من تاريخ</label><input id="dateFrom" type="date"></div>
        <div><label>إلى تاريخ</label><input id="dateTo" type="date"></div>
        <div><label>من شهر</label><input id="monthFrom" type="month"></div>
        <div><label>إلى شهر</label><input id="monthTo" type="month"></div>
        <div class="row" style="align-items:flex-end"><button class="btn secondary" id="clearFilters">مسح التصفية</button></div>
      </div>
    </section>

    <!-- KPIs -->
    <section style="margin-top:16px">
      <div class="kpis" id="kpis">
        <div class="kpi"><div class="muted">إجمالي المصروفات (الكل)</div><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi"><div class="muted">إجمالي تم الصرف</div><div class="val" id="kpiPaid">0</div></div>
        <div class="kpi"><div class="muted">إجمالي لم يتم</div><div class="val" id="kpiUnpaid">0</div></div>
        <div class="kpi"><div class="muted">إجمالي الشهر المحدد</div><div class="val" id="kpiMonth">0</div></div>
        <div class="kpi"><div class="muted">صافي الشهر المحدد</div><div class="val" id="kpiMonthNet">0</div></div>
      </div>
    </section>

    <!-- إدخال / شركات / أصناف -->
    <div class="grid grid-3" style="margin-top:16px">
      <section class="card">
        <div class="card-head"><strong>إضافة مصروف جديد</strong></div>
        <div class="card-body grid grid-2">
          <div><label>التاريخ</label><input id="expDate" type="date"></div>
          <div><label>المبلغ</label><input id="expAmount" type="number" min="0" step="0.01" placeholder="0.00"></div>
          <div><label>الشركة (اختياري)</label><select id="expCompany"></select></div>
          <div>
            <label>اسم المصروف / الصنف</label>
            <input id="expItem" type="text" list="categoriesList" placeholder="مثال: خبز" />
            <datalist id="categoriesList"></datalist>
          </div>
          <div><label>الحالة</label>
            <select id="expStatus">
              <option value="paid">تم الصرف</option>
              <option value="unpaid">لم يتم</option>
            </select>
          </div>
          <div><label>عدد النسخ</label><input id="repeatCount" type="number" min="1" step="1" value="1" /></div>
          <div style="grid-column:1 / -1"><label>ملاحظات</label><input id="expNotes" type="text" placeholder="مثال: خبز من البقالة"></div>
          <div class="row" style="grid-column:1 / -1; gap:8px; margin-top:6px">
            <button class="btn success" id="addExpense">حفظ المصروف</button>
            <button class="btn secondary" id="resetExpenseForm">تفريغ الحقول</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head"><strong>تسجيل وإدارة الشركات</strong></div>
        <div class="card-body">
          <div class="grid grid-2">
            <div><label>اسم الشركة</label><input id="companyName" type="text" placeholder="أدخل اسم الشركة"></div>
            <div class="row" style="align-items:flex-end"><button class="btn" id="addCompany">إضافة شركة</button></div>
          </div>
          <div style="margin-top:12px">
            <table>
              <thead><tr><th>الشركة</th><th>مصروفات هذا العام</th><th>إجراءات</th></tr></thead>
              <tbody id="companiesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head"><strong>تسجيل وإدارة الأصناف</strong></div>
        <div class="card-body">
          <div class="grid grid-2">
            <div><label>اسم الصنف</label><input id="categoryName" type="text" placeholder="مثال: خبز، خضار، لحوم..."></div>
            <div class="row" style="align-items:flex-end"><button class="btn" id="addCategory">إضافة صنف</button></div>
          </div>
          <div style="margin-top:12px">
            <table>
              <thead><tr><th>الصنف</th><th>مصروفات هذا العام</th><th>إجراءات</th></tr></thead>
              <tbody id="categoriesTable"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- المبيعات اليومية بالقنوات -->
    <section class="card" style="margin-top:16px">
      <div class="card-head"><strong>المبيعات اليومية حسب القناة</strong></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>التاريخ</label><input id="dsDate" type="date"></div>
          <div><label>شبكة</label><input id="dsNetwork" type="number" step="0.01" min="0" placeholder="0.00"></div>
          <div><label>كاش</label><input id="dsCash" type="number" step="0.01" min="0" placeholder="0.00"></div>
          <div><label>تويو</label><input id="dsToyou" type="number" step="0.01" min="0" placeholder="0.00"></div>
          <div><label>هنقرستيشن</label><input id="dsHunger" type="number" step="0.01" min="0" placeholder="0.00"></div>
          <div class="row" style="align-items:flex-end"><button class="btn success" id="saveDailySales">حفظ / تحديث اليوم</button></div>
        </div>

        <div style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>شبكة</th>
                <th>كاش</th>
                <th>تويو</th>
                <th>هنقرستيشن</th>
                <th>الإجمالي</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="dailySalesTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- السجل + الاستيراد/التصدير -->
    <section class="card" style="margin-top:16px">
      <div class="card-head">
        <strong>سجل المصروفات</strong>
        <div class="row">
          <button class="btn warn" id="exportCSV">تصدير CSV</button>
          <button class="btn" id="exportXLSX">تصدير Excel</button>

          <!-- استيراد Excel -->
          <input id="importExcel" type="file" accept=".xlsx,.xls" style="display:none">
          <label for="importExcel" class="btn">استيراد Excel</label>
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="importExcelThisMonthOnly" checked>
            <span class="muted">استيراد هذا الشهر فقط</span>
          </label>

          <!-- استيراد/نسخ JSON -->
          <label class="btn secondary" for="importJSON" style="cursor:pointer">استيراد نسخة</label>
          <input id="importJSON" type="file" accept=".json" style="display:none">
          <button class="btn danger" id="wipeAll">مسح كل البيانات</button>
        </div>
      </div>
      <div class="card-body">
        <table>
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>الشهر</th>
              <th>الشركة</th>
              <th>الصنف / اسم المصروف</th>
              <th>المبلغ</th>
              <th>الحالة</th>
              <th>ملاحظات</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="expensesTable"></tbody>
        </table>

        <div class="row" id="pager" style="margin-top:12px; justify-content:space-between; align-items:center">
          <div class="row" style="gap:8px">
            <button class="btn secondary" data-act="first-page">الأول</button>
            <button class="btn secondary" data-act="prev-page">السابق</button>
            <div id="pageNumbers" class="row" style="gap:6px"></div>
            <button class="btn secondary" data-act="next-page">التالي</button>
            <button class="btn secondary" data-act="last-page">الأخير</button>
          </div>
          <div class="row" style="gap:8px">
            <label class="muted">صفوف بالصفحة</label>
            <select id="perPage" style="min-width:90px">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="muted" id="pageInfo"></span>
          </div>
        </div>

      </div>
    </section>

    <section class="row" style="margin-top:20px">
      <button class="btn secondary" id="downloadBackup">حفظ نسخة احتياطية (JSON)</button>
      <span class="muted">البيانات تتخزن محليًا، وتقدر تزامنها مع Supabase من الأعلى.</span>
    </section>
  </main>

  <!-- ===== App + Supabase (Module) ===== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://hefnihyqucraozjtfgnci.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZm5paHlxdWNyYW96anRmZ2NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTQwMjEsImV4cCI6MjA3MjA3MDAyMX0.OyNkzWlNvgSFc0Q7jmfvd7RQqABEsFWVVGC0EYaSvN4";
    const sb = (SUPABASE_URL.startsWith("http")) ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ========= Utils =========
    const $ = id => document.getElementById(id);
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    const read = (k, fb) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fb)); } catch { return fb; } };
    const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const sum = arr => arr.reduce((a, c) => a + (+c || 0), 0);
    const fmt = n => new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(isNaN(n) ? 0 : +n);
    const MONTHS_AR = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
    const monthIndex = d => { const p = String(d || '').split('-'); return p.length >= 2 ? (parseInt(p[1], 10) - 1) : 0; };
    const ymCode = d => String(d || '').slice(0,7);
    const daysInMonth = (y, m0) => new Date(y, m0 + 1, 0).getDate();
    const debounce = (fn, ms = 200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    // NEW: شهر مختار موحّد لكل مكان
    function getSelectedMonthCode() {
      let mCode = $('filterMonth')?.value || '';
      if (!mCode) {
        const mf = $('monthFrom')?.value, mt = $('monthTo')?.value;
        if (mf && mt && mf === mt) mCode = mf.slice(5,7);
      }
      if (!mCode) mCode = String(new Date().getMonth() + 1).padStart(2,'0');
      return mCode;
    }

    // NEW: تحويل الأرقام العربية إلى لاتينية + معالجة الفواصل
    function normalizeNumberString(s) {
      if (s == null) return '';
      let str = String(s).trim();
      const arabicDigits = '٠١٢٣٤٥٦٧٨٩';
      const western = '0123456789';
      // استبدال الأرقام العربية
      str = str.replace(/[٠-٩]/g, d => western[arabicDigits.indexOf(d)]);
      // استبدال الفاصلة العربية
      str = str.replace(/[,،]/g, '');
      // استبدال العلامة العشرية العربية '٫' إلى '.'
      str = str.replace(/٫/g, '.');
      return str;
    }

    // Excel helpers
    const excelDateToISO = (v) => {
      if (v instanceof Date) return v.toISOString().slice(0,10);
      if (typeof v === 'number' && v > 60 && v < 60000) {
        const utc_days = Math.floor(v - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        const off = date_info.getTimezoneOffset();
        const d = new Date(date_info.getTime() + off * 60 * 1000);
        return d.toISOString().slice(0,10);
      }
      const s = String(v || '').trim();
      if (!s) return '';
      const parts = s.includes('/') ? s.split('/') : s.split('-');
      if (parts.length === 3) {
        let y, m, d;
        if (s.includes('-')) { y = +parts[0]; m = +parts[1]; d = +parts[2]; }
        else { d = +parts[0]; m = +parts[1]; y = +parts[2]; }
        const dt = new Date(y, m-1, d);
        if (!isNaN(dt)) return dt.toISOString().slice(0,10);
      }
      const dt = new Date(s);
      if (!isNaN(dt)) return dt.toISOString().slice(0,10);
      return '';
    };
    const normalizeStatus = (s) => {
      const t = String(s || '').toLowerCase();
      if (!t) return 'paid';
      if (/(paid|تم|مدفوع|تم الصرف)/.test(t)) return 'paid';
      if (/(unpaid|لم يتم|غير مدفوع|معلق)/.test(t)) return 'unpaid';
      return 'paid';
    };

    // ========= State / Keys =========
    const YEAR = new Date().getFullYear();
    const K = {
      companies: 'ss_companies',
      categories: 'ss_categories',
      expenses: 'ss_expenses',
      sales: y => `ss_sales_${y}`,
      dailySales: y => `ss_daily_sales_${y}`,
      theme: 'theme'
    };

    const CHANNELS = [
      {key:'network', label:'شبكة'},
      {key:'cash', label:'كاش'},
      {key:'toyou', label:'تويو'},
      {key:'hunger', label:'هنقرستيشن'},
    ];

    const App = {
      companies: read(K.companies, []),
      categories: read(K.categories, []),
      expenses: read(K.expenses, []),
      sales: read(K.sales(YEAR), (() => { const o = {}; for (let m = 1; m <= 12; m++) o[String(m).padStart(2, '0')] = 0; return o; })()),
      dailySales: read(K.dailySales(YEAR), {}), // {'YYYY-MM-DD': {network,cash,toyou,hunger}}
      charts: { monthDays: null, topCompanies: null, topCategories: null, salesVsExp: null, monthlyMargin: null, channelShare:null },
      pagination: { currentPage: 1, perPage: 20, totalPages: 1, totalRows: 0 },

      // ---------- THEME ----------
      initTheme() {
        if (localStorage.getItem(K.theme) === 'light') document.body.classList.add('light');
        on($('toggleTheme'), 'click', () => {
          document.body.classList.toggle('light');
          localStorage.setItem(K.theme, document.body.classList.contains('light') ? 'light' : 'dark');
        });
      },

      // ---------- UI Helpers ----------
      populateSelect(select, options, withAll = false, allLabel = 'الكل') {
        if (!select) return; select.innerHTML = '';
        if (withAll) select.add(new Option(allLabel, ''));
        options.forEach(({ label, value }) => select.add(new Option(label, value)));
      },
      populateFilters() {
        this.populateSelect($('filterMonth'), MONTHS_AR.map((n, i) => ({ label: n, value: String(i + 1).padStart(2, '0') })), true);
        this.populateSelect($('filterCompany'), this.companies.map(c => ({ label: c.name, value: String(c.id) })), true);
        this.populateSelect($('filterCategory'), this.categories.map(c => ({ label: c.name, value: String(c.id) })), true);
      },
      populateDatalist() {
        const dl = $('categoriesList'); if (!dl) return;
        dl.innerHTML = this.categories.map(c => `<option value="${String(c.name).replace(/"/g, '&quot;')}"></option>`).join('');
      },

      renderCompanies() {
        const tb = $('companiesTable'); tb.innerHTML = '';
        if (this.companies.length === 0) { tb.innerHTML = '<tr><td colspan="3" class="muted">لا توجد شركات بعد</td></tr>'; return; }
        const totalForCompany = id => sum(this.expenses.filter(e => String(e.companyId || '') === String(id)).map(e => +e.amount || 0));
        this.companies.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.name}</td>
            <td>${fmt(totalForCompany(c.id))}</td>
            <td><button class="btn danger" data-act="del-company" data-id="${c.id}">حذف</button></td>`;
          tb.appendChild(tr);
        });
      },

      renderCategories() {
        const tb = $('categoriesTable'); tb.innerHTML = '';
        if (this.categories.length === 0) { tb.innerHTML = '<tr><td colspan="3" class="muted">لا توجد أصناف بعد</td></tr>'; return; }
        const totalForCategory = id => sum(this.expenses.filter(e => String(e.categoryId || '') === String(id)).map(e => +e.amount || 0));
        this.categories.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.name}</td>
            <td>${fmt(totalForCategory(c.id))}</td>
            <td><button class="btn danger" data-act="del-category" data-id="${c.id}">حذف</button></td>`;
          tb.appendChild(tr);
        });
      },

      // ===== Daily Sales =====
      setDailySales(dateISO, vals) {
        if (!dateISO) return;
        const clean = {
          network: +vals.network || 0,
          cash: +vals.cash || 0,
          toyou: +vals.toyou || 0,
          hunger: +vals.hunger || 0
        };
        this.dailySales[dateISO] = clean;
        write(K.dailySales(YEAR), this.dailySales);
      },
      removeDailySales(dateISO) {
        delete this.dailySales[dateISO];
        write(K.dailySales(YEAR), this.dailySales);
      },
      monthSalesFromDaily(mIdx0) { // 0..11
        const y = new Date().getFullYear();
        const mm = String(mIdx0+1).padStart(2,'0');
        let total = 0;
        Object.entries(this.dailySales).forEach(([d, v]) => {
          if (d.startsWith(`${y}-${mm}-`)) {
            total += (+v.network||0)+(+v.cash||0)+(+v.toyou||0)+(+v.hunger||0);
          }
        });
        return total;
      },
      channelShareForMonth(mIdx0){
        const y = new Date().getFullYear();
        const mm = String(mIdx0+1).padStart(2,'0');
        const agg = {network:0,cash:0,toyou:0,hunger:0};
        Object.entries(this.dailySales).forEach(([d, v]) => {
          if (d.startsWith(`${y}-${mm}-`)) {
            agg.network += (+v.network||0);
            agg.cash += (+v.cash||0);
            agg.toyou += (+v.toyou||0);
            agg.hunger += (+v.hunger||0);
          }
        });
        return agg;
      },
      renderDailySalesTable() {
        const tb = $('dailySalesTable'); tb.innerHTML = '';
        const mCode = getSelectedMonthCode();
        const y = new Date().getFullYear();
        const days = daysInMonth(y, parseInt(mCode,10)-1);
        let sumRow = {network:0,cash:0,toyou:0,hunger:0};
        for (let d=1; d<=days; d++){
          const dateISO = `${y}-${mCode}-${String(d).padStart(2,'0')}`;
          const v = this.dailySales[dateISO] || {network:0,cash:0,toyou:0,hunger:0};
          const total = (+v.network||0)+(+v.cash||0)+(+v.toyou||0)+(+v.hunger||0);
          sumRow.network += (+v.network||0);
          sumRow.cash += (+v.cash||0);
          sumRow.toyou += (+v.toyou||0);
          sumRow.hunger += (+v.hunger||0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dateISO}</td>
            <td>${fmt(v.network)}</td>
            <td>${fmt(v.cash)}</td>
            <td>${fmt(v.toyou)}</td>
            <td>${fmt(v.hunger)}</td>
            <td>${fmt(total)}</td>
            <td><button class="btn danger" data-act="del-day" data-date="${dateISO}">حذف</button></td>
          `;
          tb.appendChild(tr);
        }
        const totalSum = sumRow.network+sumRow.cash+sumRow.toyou+sumRow.hunger;
        const trSum = document.createElement('tr');
        trSum.innerHTML = `
          <td><b>مجموع الشهر</b></td>
          <td><b>${fmt(sumRow.network)}</b></td>
          <td><b>${fmt(sumRow.cash)}</b></td>
          <td><b>${fmt(sumRow.toyou)}</b></td>
          <td><b>${fmt(sumRow.hunger)}</b></td>
          <td><b>${fmt(totalSum)}</b></td>
          <td></td>
        `;
        tb.appendChild(trSum);
      },

      // ===== Filters for expenses =====
      applyFilters(rows) {
        const term = ($('q')?.value || '').trim().toLowerCase();
        const m = $('filterMonth')?.value, comp = $('filterCompany')?.value, cat = $('filterCategory')?.value, st = $('filterStatus')?.value;
        const from = $('dateFrom')?.value ? new Date($('dateFrom').value) : null;
        const to = $('dateTo')?.value ? new Date($('dateTo').value) : null;
        const mFrom = $('monthFrom')?.value || '';
        const mTo = $('monthTo')?.value || '';

        let out = rows.slice();
        if (term) {
          out = out.filter(r =>
            String(r.companyName || '').toLowerCase().includes(term) ||
            String(r.categoryName || '').toLowerCase().includes(term) ||
            String(r.status || '').toLowerCase().includes(term) ||
            String(r.notes || '').toLowerCase().includes(term)
          );
        }
        if (m) out = out.filter(r => String(monthIndex(r.date) + 1).padStart(2, '0') === m);
        if (comp) out = out.filter(r => String(r.companyId || '') === String(comp));
        if (cat) out = out.filter(r => String(r.categoryId || '') === String(cat));
        if (st) out = out.filter(r => r.status === st);
        if (from) out = out.filter(r => new Date(r.date) >= from);
        if (to) out = out.filter(r => new Date(r.date) <= to);
        if (mFrom) out = out.filter(r => ymCode(r.date) >= mFrom);
        if (mTo) out = out.filter(r => ymCode(r.date) <= mTo);
        return out.sort((a, b) => new Date(b.date) - new Date(a.date));
      },

      // ===== Table + Pagination =====
      renderPager(total, page, perPage) {
        const pageNumbers = document.getElementById('pageNumbers');
        const pageInfo = document.getElementById('pageInfo');
        const totalPages = Math.max(1, Math.ceil(total / perPage));
        this.pagination.totalRows = total;
        this.pagination.totalPages = totalPages;
        this.pagination.currentPage = Math.min(page, totalPages);

        const maxBtns = 7;
        let start = Math.max(1, this.pagination.currentPage - Math.floor(maxBtns / 2));
        let end = Math.min(totalPages, start + maxBtns - 1);
        if (end - start + 1 < maxBtns) start = Math.max(1, end - maxBtns + 1);

        pageNumbers.innerHTML = '';
        for (let p = start; p <= end; p++) {
          const b = document.createElement('button');
          b.className = 'btn ' + (p === this.pagination.currentPage ? '' : 'secondary');
          b.setAttribute('data-page', String(p));
          b.textContent = String(p);
          pageNumbers.appendChild(b);
        }

        const from = total === 0 ? 0 : ((this.pagination.currentPage - 1) * perPage + 1);
        const to = Math.min(total, this.pagination.currentPage * perPage);
        pageInfo.textContent = `عرض ${from}-${to} من ${total}`;
      },

      renderTable() {
        const tb = $('expensesTable'); tb.innerHTML = '';
        const allRows = this.applyFilters(this.expenses);

        const perPageSel = $('perPage');
        if (perPageSel) this.pagination.perPage = parseInt(perPageSel.value, 10) || 20;

        const total = allRows.length;
        const totalPages = Math.max(1, Math.ceil(total / this.pagination.perPage));
        if (this.pagination.currentPage > totalPages) this.pagination.currentPage = totalPages;
        if (this.pagination.currentPage < 1) this.pagination.currentPage = 1;

        const startIdx = (this.pagination.currentPage - 1) * this.pagination.perPage;
        const endIdx = Math.min(total, startIdx + this.pagination.perPage);
        const pageRows = allRows.slice(startIdx, endIdx);

        if (pageRows.length === 0) {
          tb.innerHTML = '<tr><td colspan="8" class="muted">لا توجد نتائج</td></tr>';
        } else {
          const frag = document.createDocumentFragment();
          pageRows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.date || ''}</td>
              <td>${MONTHS_AR[monthIndex(r.date)] || ''}</td>
              <td>${r.companyName || ''}</td>
              <td>${r.categoryName || ''}</td>
              <td>${fmt(r.amount || 0)}</td>
              <td>${r.status === 'paid' ? '<span class="pill paid">تم الصرف</span>' : '<span class="pill unpaid">لم يتم</span>'}</td>
              <td>${r.notes || ''}</td>
              <td>
                <button class="btn secondary" data-act="toggle" data-id="${r.id}">${r.status === 'paid' ? 'تعليم كـ لم يتم' : 'تعليم كـ تم'}</button>
                <button class="btn" data-act="dup" data-id="${r.id}">نسخ</button>
                <button class="btn danger" data-act="del" data-id="${r.id}">حذف</button>
              </td>`;
            frag.appendChild(tr);
          });
          tb.appendChild(frag);
        }

        this.renderPager(total, this.pagination.currentPage, this.pagination.perPage);
      },

      // ===== KPIs =====
      renderKPIs() {
        const all = this.expenses;
        const totalAll = sum(all.map(r => +r.amount || 0));
        const totalPaid = sum(all.filter(r => r.status === 'paid').map(r => +r.amount || 0));
        const totalUnpaid = sum(all.filter(r => r.status !== 'paid').map(r => +r.amount || 0));
        const mCode = getSelectedMonthCode();
        const monthTotalExp = sum(all.filter(r => String(monthIndex(r.date)+1).padStart(2,'0') === mCode).map(r => +r.amount || 0));
        const monthSales = this.monthSalesFromDaily(parseInt(mCode,10)-1);
        $('kpiTotal').textContent = fmt(totalAll);
        $('kpiPaid').textContent = fmt(totalPaid);
        $('kpiUnpaid').textContent = fmt(totalUnpaid);
        $('kpiMonth').textContent = fmt(monthTotalExp);
        $('kpiMonthNet').textContent = fmt(monthSales - monthTotalExp);
      },

      // ===== Charts =====
      updateCharts() {
        if (typeof Chart === 'undefined') return;
        const rows = this.applyFilters(this.expenses);

        const mCode = getSelectedMonthCode();
        const mIdx = parseInt(mCode,10)-1;
        const days = daysInMonth(new Date().getFullYear(), mIdx);
        const dayTotals = Array.from({length: days}, ()=>0);
        rows.filter(r => monthIndex(r.date) === mIdx).forEach(r => {
          const d = new Date(r.date).getDate();
          if (d>=1 && d<=days) dayTotals[d-1] += (+r.amount||0);
        });
        const monthName = MONTHS_AR[mIdx];
        const mk = (id, cfgMaker, key) => {
          const el = $(id); if (!el) return;
          const ctx = el.getContext('2d');
          if (this.charts[key]) this.charts[key].destroy();
          this.charts[key] = new Chart(ctx, cfgMaker());
        };
        $('chartMonthLabel').textContent = `(${monthName})`;
        mk('chartMonthDays', () => ({
          type: 'bar',
          data: { labels: Array.from({length: days}, (_,i)=>String(i+1)), datasets: [{ label: 'مصروفات', data: dayTotals }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        }), 'monthDays');

        const byCompMap = new Map();
        rows.forEach(r => {
          const k = r.companyName || '—';
          byCompMap.set(k, (byCompMap.get(k)||0) + (+r.amount||0));
        });
        const byComp = Array.from(byCompMap, ([name, total]) => ({name,total})).sort((a,b)=>b.total-a.total).slice(0,6);
        mk('chartTopCompanies', () => ({
          type: 'bar',
          data: { labels: byComp.map(x=>x.name), datasets: [{ label: 'إجمالي الصرف', data: byComp.map(x=>x.total) }] },
          options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        }), 'topCompanies');

        const byCatMap = new Map();
        rows.forEach(r => {
          const k = r.categoryName || '—';
          byCatMap.set(k, (byCatMap.get(k)||0) + (+r.amount||0));
        });
        const byCat = Array.from(byCatMap, ([name, total]) => ({name,total})).sort((a,b)=>b.total-a.total).slice(0,6);
        mk('chartTopCategories', () => ({
          type: 'bar',
          data: { labels: byCat.map(x=>x.name), datasets: [{ label: 'إجمالي الصرف', data: byCat.map(x=>x.total) }] },
          options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        }), 'topCategories');

        const monthlyExpenses = Array.from({length:12}, (_,i)=> rows.filter(r => monthIndex(r.date)===i).reduce((a,c)=>a+(+c.amount||0),0));
        const monthlySales = Array.from({length:12}, (_,i)=> this.monthSalesFromDaily(i));
        mk('chartSalesVsExpenses', () => ({
          type: 'bar',
          data: {
            labels: MONTHS_AR,
            datasets: [
              { label: 'المبيعات', data: monthlySales },
              { label: 'المصروفات', data: monthlyExpenses }
            ]
          },
          options: { responsive: true }
        }), 'salesVsExp');

        const monthlyMargin = monthlySales.map((s, i) => s - monthlyExpenses[i]);
        mk('chartMonthlyMargin', () => ({
          type: 'bar',
          data: { labels: MONTHS_AR, datasets: [{ label: 'هامش الربح', data: monthlyMargin }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        }), 'monthlyMargin');

        const share = this.channelShareForMonth(mIdx);
        mk('chartChannelShare', () => ({
          type: 'pie',
          data: {
            labels: ['شبكة','كاش','تويو','هنقرستيشن'],
            datasets: [{ label: 'حصة القنوات', data: [share.network, share.cash, share.toyou, share.hunger] }]
          },
          options: { responsive: true }
        }), 'channelShare');
      },

      // ---------- Local CRUD ----------
      addCompanyLocal(name) {
        const exists = this.companies.some(c => c.name.toLowerCase() === name.toLowerCase());
        if (exists) return false;
        this.companies.push({ id: uid(), name });
        write(K.companies, this.companies);
        return true;
      },
      addCategoryLocal(name) {
        const exists = this.categories.some(c => c.name.toLowerCase() === name.toLowerCase());
        if (exists) return false;
        this.categories.push({ id: uid(), name });
        write(K.categories, this.categories);
        return true;
      },
      addExpenseLocal(row) {
        this.expenses.push(row);
        write(K.expenses, this.expenses);
      },

      // ---------- Remote (Supabase) ----------
      async login(email, password) {
        if (!sb) return alert('أدخل إعدادات Supabase أولًا.');
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) alert('خطأ دخول: ' + error.message);
        else alert('تم الدخول ✅');
      },
      async logout() { if (sb) await sb.auth.signOut(); },

      // FIX: سحب/رفع مع حذر من التكرارات
      async pullRemote() {
        if (!sb) return alert('Supabase غير مُعد.');
        const { data: cats, error: e1 } = await sb.from('categories').select('*').order('name');
        if (e1) return alert('خطأ سحب الأصناف: ' + e1.message);
        const { data: comps, error: e2 } = await sb.from('companies').select('*').order('name');
        if (e2) return alert('خطأ سحب الشركات: ' + e2.message);
        const { data: exps, error: e3 } = await sb.from('expenses')
          .select(`id, dt, amount, status, notes, company_id, category_id,
                   companies:company_id ( name ),
                   categories:category_id ( name )`)
          .order('dt', { ascending: true });
        if (e3) return alert('خطأ سحب المصروفات: ' + e3.message);

        this.categories = cats.map(c => ({ id: String(c.id), name: c.name }));
        this.companies = comps.map(c => ({ id: String(c.id), name: c.name }));
        this.expenses = exps.map(r => ({
          id: String(r.id),
          date: r.dt,
          amount: Number(r.amount),
          status: r.status,
          notes: r.notes || '',
          companyId: r.company_id ? String(r.company_id) : '',
          companyName: r.companies?.name || '',
          categoryId: r.category_id ? String(r.category_id) : '',
          categoryName: r.categories?.name || ''
        }));

        write(K.categories, this.categories);
        write(K.companies, this.companies);
        write(K.expenses, this.expenses);
        this.renderAll();
        alert('تم السحب من Supabase ✅');
      },

      async pushRemote() {
        if (!sb) return alert('Supabase غير مُعد.');
        const ensureMany = async (table, names) => {
          const uniq = [...new Set(names.filter(Boolean).map(s => s.trim()))];
          if (uniq.length === 0) return {};
          const { data: existing } = await sb.from(table).select('*').in('name', uniq);
          const map = new Map((existing || []).map(r => [r.name, String(r.id)]));
          const toInsert = uniq.filter(n => !map.has(n)).map(n => ({ name: n }));
          if (toInsert.length) {
            const { data: inserted, error } = await sb.from(table).insert(toInsert).select('*');
            if (error) throw error;
            inserted.forEach(r => map.set(r.name, String(r.id)));
          }
          return Object.fromEntries(map);
        };

        try {
          const catNames = this.categories.map(c => c.name);
          const compNames = this.companies.map(c => c.name);
          const catMap = await ensureMany('categories', catNames);
          const compMap = await ensureMany('companies', compNames);

          const rows = this.expenses.map(r => {
            const catRaw = r.categoryName ? (catMap[r.categoryName] ?? r.categoryId ?? null) : (r.categoryId ?? null);
            const compRaw = r.companyName ? (compMap[r.companyName] ?? r.companyId ?? null) : (r.companyId ?? null);
            return {
              dt: r.date, amount: r.amount, status: r.status, notes: r.notes || null,
              category_id: catRaw != null ? Number(catRaw) : null,
              company_id: compRaw != null ? Number(compRaw) : null,
            };
          });

          // NEW: فلترة التكرارات قبل الإدراج (مفتاح مبسّط)
          const keyOf = r => [r.dt, r.amount, r.status, r.notes ?? '', r.company_id ?? '', r.category_id ?? ''].join('|');
          const { data: existingRows } = await sb.from('expenses').select('dt, amount, status, notes, company_id, category_id');
          const existingKeys = new Set((existingRows||[]).map(keyOf));
          const toInsert = rows.filter(r => !existingKeys.has(keyOf(r)));

          if (toInsert.length) {
            const { error } = await sb.from('expenses').insert(toInsert);
            if (error) throw error;
          }
          alert('تم رفع البيانات إلى Supabase ✅' + (toInsert.length ? '' : ' (لا توجد سجلات جديدة)'));
        } catch (err) {
          alert('تعذر الرفع: ' + (err?.message || err));
        }
      },

      // ---------- Events ----------
      bindEvents() {
        const rerender = debounce(() => {
          this.pagination.currentPage = 1;
          this.renderTable(); this.renderKPIs(); this.updateCharts(); this.renderDailySalesTable();
        }, 200);

        ['q','filterMonth','filterCompany','filterCategory','filterStatus','dateFrom','dateTo','monthFrom','monthTo']
          .map(id => $(id)).filter(Boolean).forEach(el => on(el, 'input', rerender));

        on($('clearFilters'), 'click', () => {
          ['q','filterMonth','filterCompany','filterCategory','filterStatus','dateFrom','dateTo','monthFrom','monthTo']
            .forEach(id => { const el = $(id); if (el) el.value = ''; });
          this.renderAll();
        });

        // شركات
        on($('addCompany'), 'click', () => {
          const name = ($('companyName').value || '').trim();
          if (!name) return alert('اكتب اسم الشركة');
          if (!this.addCompanyLocal(name)) return alert('هذه الشركة مسجلة بالفعل');
          $('companyName').value = ''; this.populateFilters(); this.renderCompanies(); this.renderAll();
        });

        // أصناف
        on($('addCategory'), 'click', () => {
          const name = ($('categoryName').value || '').trim();
          if (!name) return alert('اكتب اسم الصنف');
          if (!this.addCategoryLocal(name)) return alert('هذا الصنف مسجل بالفعل');
          $('categoryName').value = ''; this.populateFilters(); this.populateDatalist(); this.renderCategories(); this.renderAll();
        });

        // مصروف جديد
        on($('addExpense'), 'click', () => {
          const date = $('expDate').value;
          // NEW: نقبل كتابة عربية للمبلغ أيضاً
          const amountRaw = $('expAmount').value;
          const amount = parseFloat(normalizeNumberString(amountRaw));
          const companyId = $('expCompany').value || null;
          const itemName = ($('expItem').value || '').trim();
          const status = $('expStatus').value;
          const notes = ($('expNotes').value || '').trim();
          const copies = Math.max(1, parseInt($('repeatCount').value, 10) || 1);
          if (!date) return alert('اختر التاريخ');
          if (!(amount >= 0)) return alert('أدخل المبلغ بشكل صحيح');
          if (!itemName) return alert('اكتب اسم المصروف / الصنف');

          let category = this.categories.find(c => c.name.toLowerCase() === itemName.toLowerCase());
          if (!category) { category = { id: uid(), name: itemName }; this.categories.push(category); write(K.categories, this.categories); this.populateFilters(); this.populateDatalist(); this.renderCategories(); }
          const company = this.companies.find(c => String(c.id) === String(companyId));

          for (let i = 0; i < copies; i++) {
            this.addExpenseLocal({
              id: uid(), date, amount,
              companyId, companyName: company ? company.name : '',
              categoryId: category.id, categoryName: category.name,
              status, notes
            });
          }
          ['expAmount','expItem','expNotes'].forEach(id => $(id).value=''); $('expCompany').value=''; $('repeatCount').value='1';
          this.renderAll();
        });

        on($('resetExpenseForm'), 'click', () => {
          ['expDate','expAmount','expItem','expNotes','expCompany','repeatCount'].forEach(id => {
            const el = $(id); if (!el) return;
            el.value = (id==='repeatCount')?'1':'';
          });
        });

        // جدول المصروفات
        on($('expensesTable'), 'click', (e) => {
          const btn = e.target.closest('button[data-act]'); if (!btn) return;
          const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
          const row = this.expenses.find(x => x.id === id);
          if (!row && act !== 'dup') return;
          if (act === 'del') {
            if (confirm('حذف السجل؟')) { this.expenses = this.expenses.filter(x => x.id !== id); write(K.expenses, this.expenses); this.renderAll(); }
          } else if (act === 'toggle') {
            row.status = row.status === 'paid' ? 'unpaid' : 'paid'; write(K.expenses, this.expenses); this.renderAll();
          } else if (act === 'dup') {
            const src = this.expenses.find(x => x.id === id); if (!src) return; const n = parseInt(prompt('كم نسخة؟', '1'), 10) || 1;
            for (let i = 0; i < n; i++) this.expenses.push({ ...src, id: uid() }); write(K.expenses, this.expenses); this.renderAll();
          }
        });

        // حذف شركة/صنف
        on($('companiesTable'), 'click', e => {
          const btn = e.target.closest('button[data-act="del-company"]'); if (!btn) return;
          const id = btn.getAttribute('data-id');
          if (confirm('حذف الشركة سيحذف المصروفات المرتبطة بها محليًا.')) {
            this.expenses = this.expenses.filter(x => String(x.companyId || '') !== String(id));
            this.companies = this.companies.filter(x => String(x.id) !== String(id));
            write(K.expenses, this.expenses); write(K.companies, this.companies);
            this.populateFilters(); this.renderCompanies(); this.renderAll();
          }
        });
        on($('categoriesTable'), 'click', e => {
          const btn = e.target.closest('button[data-act="del-category"]'); if (!btn) return;
          const id = btn.getAttribute('data-id');
          if (confirm('حذف الصنف سيحذف المصروفات المرتبطة به محليًا.')) {
            this.expenses = this.expenses.filter(x => String(x.categoryId || '') !== String(id));
            this.categories = this.categories.filter(x => String(x.id) !== String(id));
            write(K.expenses, this.expenses); write(K.categories, this.categories);
            this.populateFilters(); this.renderCategories(); this.renderAll();
          }
        });

        // ===== Daily sales events =====
        on($('saveDailySales'), 'click', () => {
          const date = $('dsDate').value;
          if (!date) return alert('اختر التاريخ للمبيعات اليومية');
          const vals = {
            network: parseFloat(normalizeNumberString($('dsNetwork').value)) || 0,
            cash: parseFloat(normalizeNumberString($('dsCash').value)) || 0,
            toyou: parseFloat(normalizeNumberString($('dsToyou').value)) || 0,
            hunger: parseFloat(normalizeNumberString($('dsHunger').value)) || 0,
          };
          this.setDailySales(date, vals);
          ['dsNetwork','dsCash','dsToyou','dsHunger'].forEach(id => $(id).value='');
          this.renderDailySalesTable();
          this.renderKPIs();
          this.updateCharts();
          alert('تم حفظ/تحديث مبيعات اليوم ✅');
        });

        on($('dailySalesTable'), 'click', (e) => {
          const btn = e.target.closest('button[data-act="del-day"]'); if (!btn) return;
          const date = btn.getAttribute('data-date');
          if (!date) return;
          if (!confirm(`حذف مبيعات يوم ${date}؟`)) return;
          this.removeDailySales(date);
          this.renderDailySalesTable();
          this.renderKPIs();
          this.updateCharts();
        });

        // CSV
        on($('exportCSV'), 'click', () => {
          const rows = this.applyFilters(this.expenses).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
          const header = ['date','month','company','category','amount','status','notes'];
          const lines = [header.join(',')];
          rows.forEach(r => {
            const monthName = MONTHS_AR[monthIndex(r.date)];
            const row = [r.date, monthName, (r.companyName || ''), (r.categoryName || ''), (r.amount || 0), (r.status === 'paid' ? 'تم' : 'لم يتم'), (r.notes || '')].map(x => `"${String(x).replace(/"/g, '""')}"`);
            lines.push(row.join(','));
          });
          const nameHint = (() => {
            const m = $('filterMonth')?.value;
            const mf = $('monthFrom')?.value, mt = $('monthTo')?.value;
            if (m) return `-m${m}`;
            if (mf && mt) return `-${mf}_to_${mt}`;
            return `-${YEAR}`;
          })();
          const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a');
          a.href = URL.createObjectURL(blob); a.download = `sekh-shish-expenses${nameHint}.csv`; a.click();
        });

        // Excel Export (XLSX)
        on($('exportXLSX'), 'click', () => {
          const rows = this.applyFilters(this.expenses).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
          const json = rows.map(r => ({
            'التاريخ': r.date || '',
            'الشهر': MONTHS_AR[monthIndex(r.date)] || '',
            'الشركة': r.companyName || '',
            'الصنف / اسم المصروف': r.categoryName || '',
            'المبلغ': +r.amount || 0,
            'الحالة': r.status === 'paid' ? 'تم' : 'لم يتم',
            'ملاحظات': r.notes || ''
          }));
          const ws = XLSX.utils.json_to_sheet(json);
          // NEW: أعمدة أوسع
          ws['!cols'] = [{wch:12},{wch:10},{wch:18},{wch:22},{wch:12},{wch:10},{wch:24}];
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
          const nameHint = (() => {
            const m = $('filterMonth')?.value;
            const mf = $('monthFrom')?.value, mt = $('monthTo')?.value;
            if (m) return `-m${m}`;
            if (mf && mt) return `-${mf}_to_${mt}`;
            return `-${YEAR}`;
          })();
          XLSX.writeFile(wb, `sekh-shish-expenses${nameHint}.xlsx`);
        });

        // Backup JSON
        on($('downloadBackup'), 'click', () => {
          const dump = {
            companies: this.companies,
            categories: this.categories,
            expenses: this.expenses,
            sales: this.sales,
            dailySales: this.dailySales,
            year: YEAR
          };
          const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' }); const a = document.createElement('a');
          a.href = URL.createObjectURL(blob); a.download = `sekh-shish-backup-${YEAR}.json`; a.click();
        });

        // Import JSON
        on($('importJSON'), 'change', (e) => {
          const file = e.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(reader.result);
              const valid = data && typeof data === 'object' && Array.isArray(data.companies) && Array.isArray(data.expenses);
              if (!valid) return alert('الملف غير صالح');
              this.companies = data.companies; this.expenses = data.expenses; this.categories = Array.isArray(data.categories) ? data.categories : this.categories;
              if (data.sales) this.sales = data.sales;
              if (data.dailySales) {
                // NEW: نحترم year إن وُجد
                const y = data.year && /^\d{4}$/.test(String(data.year)) ? Number(data.year) : YEAR;
                this.dailySales = data.dailySales;
                write(K.dailySales(y), this.dailySales);
              }
              write(K.companies, this.companies); write(K.expenses, this.expenses); write(K.categories, this.categories);
              write(K.sales(YEAR), this.sales);
              this.renderAll(); alert('تم الاستيراد بنجاح');
            } catch { alert('تعذر قراءة الملف'); }
            e.target.value = '';
          };
          reader.readAsText(file);
        });

        // Import Excel (expenses)
        on($('importExcel'), 'change', async (e) => {
          const file = e.target.files[0]; if (!file) return;
          const onlyThisMonth = $('importExcelThisMonthOnly')?.checked;
          const selectedMonth = getSelectedMonthCode();
          try {
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array', cellDates: true });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });

            const mapHeaders = (obj) => {
              const get = (...keys) => {
                for (const k of keys) {
                  const hit = Object.keys(obj).find(h => h.trim().toLowerCase() === k.toLowerCase());
                  if (hit) return obj[hit];
                }
                return '';
              };
              const rawDate = get('التاريخ','date','Date');
              const dateISO = excelDateToISO(rawDate);
              const company = get('الشركة','Company','vendor','supplier');
              const category = get('الصنف','اسم المصروف','category','item','name');
              const amountStr = normalizeNumberString(get('المبلغ','amount','price'));
              const amount = parseFloat(amountStr) || 0;
              const status = normalizeStatus(get('الحالة','status'));
              const notes  = get('ملاحظات','notes','comment','description');

              return { date: dateISO, companyName: company, categoryName: category, amount, status, notes };
            };

            const items = rows.map(mapHeaders).filter(r => r.date);
            const filteredItems = onlyThisMonth
              ? items.filter(r => String(monthIndex(r.date)+1).padStart(2,'0') === selectedMonth)
              : items;

            const ensureCat = (name) => {
              const n = (name||'').trim(); if (!n) return null;
              let c = this.categories.find(x => x.name.toLowerCase() === n.toLowerCase());
              if (!c) { c = { id: uid(), name: n }; this.categories.push(c); }
              return c.id;
            };
            const ensureComp = (name) => {
              const n = (name||'').trim(); if (!n) return null;
              let c = this.companies.find(x => x.name.toLowerCase() === n.toLowerCase());
              if (!c) { c = { id: uid(), name: n }; this.companies.push(c); }
              return c.id;
            };

            filteredItems.forEach(r => {
              const cid = ensureComp(r.companyName);
              const catid = ensureCat(r.categoryName);
              this.expenses.push({
                id: uid(),
                date: r.date,
                amount: r.amount,
                status: r.status,
                notes: r.notes || '',
                companyId: cid || '',
                companyName: r.companyName || '',
                categoryId: catid || '',
                categoryName: r.categoryName || ''
              });
            });

            write(K.categories, this.categories);
            write(K.companies, this.companies);
            write(K.expenses, this.expenses);
            this.renderAll();
            alert('تم استيراد ملف Excel بنجاح ✅');
          } catch (err) {
            console.error(err);
            alert('تعذر استيراد Excel: ' + (err?.message || err));
          } finally {
            e.target.value = '';
          }
        });

        // Pager controls
        on($('perPage'), 'change', () => { this.pagination.currentPage = 1; this.renderTable(); });
        on($('pager'), 'click', (e) => {
          const btn = e.target.closest('button'); if (!btn) return;
          const act = btn.getAttribute('data-act');
          const goto = btn.getAttribute('data-page');
          if (goto) { this.pagination.currentPage = parseInt(goto, 10); this.renderTable(); return; }
          if (act === 'first-page') this.pagination.currentPage = 1;
          else if (act === 'prev-page') this.pagination.currentPage = Math.max(1, this.pagination.currentPage - 1);
          else if (act === 'next-page') this.pagination.currentPage = Math.min(this.pagination.totalPages, this.pagination.currentPage + 1);
          else if (act === 'last-page') this.pagination.currentPage = this.pagination.totalPages;
          this.renderTable();
        });

        // Auth + Sync (حراسات لأن الـHTML معلّق)
        on($('loginForm'), 'submit', async (e) => { if (!$('loginForm')) return; e.preventDefault(); await this.login($('email').value, $('password').value); updateAuthUI(); });
        on($('logoutBtn'), 'click', async () => { if (!$('logoutBtn')) return; await this.logout(); updateAuthUI(); });
        on($('pullRemote'), 'click', async () => { if (!$('pullRemote')) return; await this.pullRemote(); });
        on($('pushRemote'), 'click', async () => { if (!$('pushRemote')) return; await this.pushRemote(); });

        // Wipe all
        on($('wipeAll'), 'click', () => {
          if (!confirm('متأكد تريد مسح كل البيانات المحلية؟')) return;
          this.companies = []; this.categories = []; this.expenses = [];
          this.sales = {}; this.dailySales = {};
          write(K.companies, this.companies); write(K.categories, this.categories);
          write(K.expenses, this.expenses); write(K.sales(YEAR), this.sales); write(K.dailySales(YEAR), this.dailySales);
          this.renderAll();
        });
      },

      renderAll() {
        $('currentYear').textContent = YEAR;
        $('expCompany').innerHTML = `<option value="">— بدون شركة —</option>` + this.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        this.populateFilters();
        this.populateDatalist();
        this.renderCompanies();
        this.renderCategories();
        this.renderDailySalesTable();
        this.renderTable();
        this.renderKPIs();
        this.updateCharts();
      },

      boot() {
        if (this.companies.length === 0) { this.companies = [{ id: uid(), name: 'مورد الخضار' }, { id: uid(), name: 'مورد اللحوم' }]; write(K.companies, this.companies); }
        if (this.categories.length === 0) { this.categories = [{ id: uid(), name: 'خبز' }, { id: uid(), name: 'خضار' }, { id: uid(), name: 'لحوم' }]; write(K.categories, this.categories); }
        const jan1 = new Date(YEAR, 0, 1), today = new Date();
        if ($('dateFrom')) $('dateFrom').value = jan1.toISOString().slice(0, 10);
        if ($('dateTo')) $('dateTo').value = today.toISOString().slice(0, 10);

        this.initTheme();
        this.bindEvents();
        this.renderAll();
      }
    };

    function updateAuthUI() {
      if (!sb) return;
      // NEW: حراسات
      const loginForm = $('loginForm');
      const authArea = $('authArea');
      const who = $('who');
      if (!loginForm || !authArea) return;
      sb.auth.getSession().then(({ data: { session } }) => {
        const logged = !!session?.user;
        loginForm.style.display = logged ? 'none' : 'flex';
        authArea.style.display = logged ? 'flex' : 'none';
        if (who) who.textContent = logged ? `مسجّل: ${session.user.email}` : '';
      });
    }

    // Start
    document.addEventListener('DOMContentLoaded', () => {
      App.boot();
      updateAuthUI();
      if (sb) sb.auth.onAuthStateChange(() => updateAuthUI());
    });
  </script>
</body>
</html>
